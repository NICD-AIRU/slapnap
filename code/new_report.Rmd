---
title: "SLAPNAP Report: `r paste(format(strsplit(Sys.getenv('nab'), split = ';')[[1]], justify = 'none'), collapse = ', ')`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: bookdown::html_document2
header-includes:
   - \usepackage{subfig}
bibliography: refs.bib
link-citations: true
---

```{r source_preamble, include = FALSE}
code_dir <- "/home/lib/"
source(paste0(code_dir, "report_preamble.R"), local = TRUE)
```

# Executive summary

The broadly neutralizing antibod`r ifelse(!one_nab, "ies (bNAbs)", "y (bNAb)")` studied in this analysis `r ifelse(!one_nab, "are ", "is ")` `r paste0(paste0(antibodies[-length(antibodies)], collapse = ", "), ifelse(length(antibodies) > 1, paste0(" and ", antibodies[length(antibodies)]), antibodies))`. The analysis considered `r length(opts$outcomes)` `r ifelse(length(opts$outcomes) == 1, "measure", "measures")` of neutralization sensitivity: `r get_comma_sep_outcomes(opts)` `r get_outcome_descriptions(opts)` Based on this specification of `r ifelse(!one_nab, "bNAbs", "bNAb")` and `r ifelse(length(opts$outcomes) > 1, "outcomes", "outcome")`:

* `r nprevious` sequences were extracted from the CATNAP database [@yoon2015catnap];

* `r ncomplete_features` sequences had complete geographic and genetic sequence information;

* `r paste0(get_complete_data_text(opts, ncomplete_ic50, ncomplete_ic80, ncomplete_ic5080, iip_undef), ifelse(any_dich, ";", "."))`
`r if(!("iip" %in% opts$outcomes) | iip_undef == 0 | opts$same_subset) "<!--"`
* out of the sequences with both IC$_{50}$ and IC$_{80}$ measured, `r iip_undef` has the same measured value of IC$_{50}$ and IC$_{80}$, which led to an undefined value for IIP and their exclusion from IIP analyses.
`r if(!("iip" %in% opts$outcomes) | iip_undef == 0 | opts$same_subset) "-->"`
`r if(!("sens1" %in% opts$outcomes)) "<!--"`
* out of the sequences with complete data, `r sum(dat_ic50$dichotomous.1)` were `r ifelse(one_nab, "", "estimated to be")` sensitive to the `r ifelse(!one_nab, "combination of antibodies", "antibody")`, while `r ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50) - sum(dat_ic50$dichotomous.1)` were `r ifelse(one_nab, "", "estimated to be")` resistant, where `r est_fillin` sensitivity was defined as the indicator that `r est_fillin` IC$_{50}$ was less than `r opts$sens_thresh``r check_sl_vimp_bin(opts, run_sl_vimp_bools, "sens1")``r ifelse("sens2" %in% opts$outcomes, ";", ".")`
`r if(!("sens1" %in% opts$outcomes)) "-->"`
`r if(!("sens2" %in% opts$outcomes)) "<!--"`
* out of the sequences with complete data, `r sum(dat_ic50$dichotomous.2)` were estimated to be sensitive to `r ifelse(opts$multsens_nab == length(opts$nab), paste0(ifelse(length(opts$nab) == 2, "both", "all of the"), " antibodies"), paste0("at least ", opts$multsens_nab, ifelse(opts$multsens_nab == 1, "antibody", "antibodies")))`, while `r ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50) - sum(dat_ic50$dichotomous.2)` were estimated to be resistant to `r ifelse(opts$multsens_nab == 1, paste0(ifelse(length(opts$nab) == 2, "both", "all of the"), " antibodies"), ifelse(length(opts$nab) - as.numeric(opts$multsens_nab) == 1, "one of the antibodies", paste0(length(opts$nab) - as.numeric(opts$multsens_nab) + 1, ifelse(length(opts$nab) - as.numeric(opts$multsens_nab) == 0, " ", " or more "), "of the antibodies")))``r check_sl_vimp_bin(opts, run_sl_vimp_bools, "sens2")`
`r if(!("sens2" %in% opts$outcomes)) "-->"`

Prediction of each outcome was performed using `r get_learner_descriptions(opts)`

The specific `r ifelse((length(opts$learners) > 1) | opts$cvtune == TRUE, "algorithms", "algorithm")` used in the learning process `r ifelse((length(opts$learners) > 1) | opts$cvtune == TRUE, "are", "is")` described in Table \@ref(tab:sllibtab).

```{r sllibtab}
source(paste0(code_dir, "super_learner_libraries.R"))
this_library <- make_sl_library_vector(opts)
Description <- sapply(this_library, function(x){
  eval(parse(text = paste0("descr_", x)))
})
Description <- data.frame(Label = relabel_library(names(Description)), Description = Description)
row.names(Description) <- NULL
kable(as.data.frame(Description), col.names = c("Label", "Description"),
             caption = ifelse(length(opts$learners) == 1,
                              "Algorithms used in the analysis",
                              "Algorithms used in the super learner library"))
```

<!-- If we did cross-validated performance, print out cv performance metrics -->

`r if(!opts$cvperf) "<!--"`

```{r getcvfits}
if (opts$cvperf) {
    fit_list_out <- load_cv_fits(opts, run_sl_vimp_bools$run_sl, slfits_dir)
    cv_outcomes <- get_cv_outcomes_tables(fit_list_out, run_sl_vimp_bools$run_sl, opts)
}
```

The predictive ability of the learner was assessed using cross-validation. `r if(any_cont & opts$cvperf) paste0("The estimated cross-validated $R^2$ of the super learner for predicting ", ifelse(length(cont_nms) == 1, paste0(cont_nms, " is"), "continuous outcomes are"), " shown in Table \\@ref(tab:rsquaredtable).")` `r if(any_dich & opts$cvperf) paste0("The estimated cross-validated area under the receiver operating characteristic curve (AUC) of the super learner for predicting ", ifelse(length(bin_nms) == 1, paste0(tolower(bin_nms), " is"), "binary sensitivity measures are "), " shown in Table \\@ref(tab:auctable).")`

```{r rsquaredtable, eval = any_cont & opts$cvperf}
get_cv_outcomes_tables(fit_list_out, run_sl_vimp_bools$run_sl, opts)[[1]]
```

```{r auctable, eval = any_dich & opts$cvperf}
# apparently no way around calling this function multiple times
# otherwise the labeling messes up
get_cv_outcomes_tables(fit_list_out, run_sl_vimp_bools$run_sl, opts)[[2]]
```

`r if(!opts$cvperf) "-->"`

<!-- If we did marginal group variable importance, print the next section -->
`r if (!("marg" %in% opts$importance_grp)) "<!--"`
We define the marginal biological importance of a subgroup of features as the difference in population predictiveness between the best possible prediction function based on the features under consideration plus geographic confounders versus only geographic confounders [@williamson2020]. In Table \@ref(tab:vimpgrpmarg), we display the groups of variables and their ranked marginal biological variable importance for predicting `r ifelse(length(opts$outcomes) == 1, get_comma_sep_outcomes(opts), "each outcome.")` `r ifelse(length(opts$outcomes) > 1, "The groups are displayed in order of decreasing average rank across outcomes.", "")` Stars next to ranks denote groups with p-value less than `r vimp_threshold` from a hypothesis test with null hypothesis of zero importance. For variable group definitions, please refer to Table \@ref(tab:vimpGroupTab).

```{r vimpgrpmarg, eval = "marg" %in% opts$importance_grp}
## vimp_summary_tbl created in preamble
vimp_summary_marg <- vimp_summary_tbl$grp_marg %>%
    select(-mn_rank, -matches("num_rank"))
## make the table
kable(vimp_summary_marg, col.names = c("Variable group", colnames(vimp_summary_marg)[-1]), caption = get_biological_importance_table_description(opts, cont_nms, bin_nms, num_obs_fulls, num_obs_reds, ncompletes, vimp_threshold, importance_type = "marginal"))
```

`r if (!("marg" %in% opts$importance_grp)) "-->"`

<!-- If we did conditional group variable importance, print the next section -->

`r if (!("cond" %in% opts$importance_grp)) "<!--"`
We define the conditional biological importance of a subgroup of features for predicting an outcome as the difference in population predictiveness between the best possible prediction function based on all available features versus all features except those under consideration [@williamson2020]. In Table \@ref(tab:vimpgrpcond), we display the groups of variables and their ranked conditional biological variable importance for predicting `r ifelse(length(opts$outcomes) == 1, get_comma_sep_outcomes(opts), "each outcome.")` The groups are displayed in order of decreasing average rank across outcomes. Stars next to ranks denote groups with p-value less than `r vimp_threshold` from a hypothesis test with null hypothesis of zero importance. For variable group definitions, please refer to Table \@ref(tab:vimpGroupTab).

```{r vimpgrpcond, eval = "cond" %in% opts$importance_grp}
## vimp_summary_tbl created in preamble
vimp_summary_cond <- vimp_summary_tbl$grp_cond %>%
    select(-mn_rank, -matches("num_rank"))
## make the table
kable(vimp_summary_cond, col.names = c("Variable group", colnames(vimp_summary_cond)[-1]), caption = get_biological_importance_table_description(opts, cont_nms, bin_nms, num_obs_fulls, num_obs_reds, ncompletes, vimp_threshold, importance_type = "conditional"))
```

`r if (!("cond" %in% opts$importance_grp)) "-->"`

<!-- If we estimated for IC-50, print the next section -->
`r if(!("ic50" %in% opts$outcomes)) "<!--"`

# Results for IC$_{50}$

## Descriptive statistics

`r if (!("ic50" %in% opts$outcomes)) "-->"`

`r if ((length(opts$nab) == 1) | !("ic50" %in% opts$outcomes)) "<!--"`

Histograms of IC$_{50}$ for each individual bNAb are shown in Figure \@ref(fig:histic50). Related summary measures are shown in \@ref(tab:tableic50)

```{r, histic50, eval = ("ic50" %in% opts$outcomes) & !one_nab, fig.cap = paste0("Distribution of IC$_{50}$ values (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50), ") for each bNAb."), fig.height=5}
ic50_descr <- get_individual_nab_summaries("ic50", opts, dat_ic50)
do.call(grid.arrange, ic50_descr$hist)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic50_hist_", postfix, ".png"), plot = do.call(grid.arrange, ic50_descr$hist), width = 20, height = 20, units = "cm")
}
```

```{r, tableic50, eval = ("ic50" %in% opts$outcomes) & !one_nab}
ic50_table <- Reduce(rbind, ic50_descr$summary)
if (is.null(dim(ic50_table))) {
  tmp <- matrix(ic50_table, nrow = 1)
  colnames(tmp) <- names(ic50_table)
  ic50_table <- tmp
}
row.names(ic50_table) <- c(paste0("IC$_{50}$ ", opts$nab))
kable(ic50_table, row.names = TRUE, digits = 3,
      caption = paste0("Summary statistics of IC$_{50}$ values for individual bNAbs (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50), " observations)."))
```

`r if ((length(opts$nab) == 1) | !("ic50" %in% opts$outcomes)) "-->"`

`r if (!("ic50" %in% opts$outcomes)) "<!--"`
A summary of the distribution of `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{50}$ for the `r ifelse(length(opts$nab) == 1, "", "combination of")` selected bNAb`r ifelse(length(opts$nab) == 1, "", "s")` is shown in Figure \@ref(fig:histcombnic50).

```{r makecapic50, eval = "ic50" %in% opts$outcomes}
ic50_figcap <- if(length(opts$nab) == 1){
  paste0("Histogram of IC$_{50}$ for the selected bNAb. Top row = original scale; bottom row = log$_{10}$ scale (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50), " observations).")
}else{
  paste0("Histogram of estimated IC$_{50}$ for the combined bNAbs. Top row = original scale; bottom row = log$_{10}$ scale (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50), " observations).")
}
```

```{r histcombnic50, eval = "ic50" %in% opts$outcomes, fig.cap = ic50_figcap}
combn_hist <- list()
combn_hist[[1]] <- make_hist_plot(dat_ic50, "pc.ic50", expression(IC[50]), "Density")
combn_hist[[2]] <- make_hist_plot(dat_ic50, "log10.pc.ic50", bquote(log[10]~"(IC"[50]~")"), "")
do.call(grid.arrange, combn_hist)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic50_combn_hist_", postfix, ".png"), plot = do.call(grid.arrange, combn_hist), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic50" %in% opts$outcomes)) "-->"`

<!-- if we used multiple learners, describe the SL -->

`r if (length(opts$learners) == 1  | !("ic50" %in% opts$outcomes)) "<!--"`

## Super learner results

The weights assigned to each algorithm for Super Learner predicting IC$_{50}$ are shown in Table \@ref(tab:ic50superlearnerweighttable).

```{r ic50superlearnerweighttable, eval = ("ic50" %in% opts$outcomes) & (length(opts$learners) > 1)}
weights_ic50 <- readRDS(paste0(slfits_dir, "slweights_fit_log10.pc.ic50.rds"))
weight_table <- data.frame(Learner = relabel_library(this_library), Weight = weights_ic50)
row.names(weight_table) <- NULL
# row.names(weight_table) <- this_library # will be defined in executive summary chunk
kable(as.data.frame(weight_table), digits = 2,
             caption = paste0("Table of super learner weights for ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{50}$ (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50), " observations)."))
```

`r if (length(opts$learners) == 1  | !("ic50" %in% opts$outcomes)) "-->"`

<!-- if we used CV to estimate SL performance, describe -->

`r if(!opts$cvperf  | !("ic50" %in% opts$outcomes)) "<!--"`

## Predictive performance

`r if (!opts$cvperf | !("ic50" %in% opts$outcomes)) "-->"`

`r if (!opts$cvperf | (length(opts$learners) == 1 & !opts$cvtune) | !("ic50" %in% opts$outcomes)) "<!--"`

The cross-validated $R^2$ of the super learner and constituent algorithms (descriptions of algorithms shown in Table \@ref(tab:sllibtab)) in predicting IC$_{50}$ are shown in Figure \@ref(fig:plotic50).

`r if (!opts$cvperf | (length(opts$learners) == 1 & !opts$cvtune) | !("ic50" %in% opts$outcomes)) "-->"`

`r if (!opts$cvperf | (length(opts$learners) > 1) | !("ic50" %in% opts$outcomes)) "<!--"`

The cross-validated $R^2$ of the learner (with tuning parameters selected via cross-validation) and of the learner with each individual value of tuning parameters are shown in Figure \@ref(fig:plotic50).

`r if (!opts$cvperf | length(opts$learners) > 1 | !("ic50" %in% opts$outcomes)) "-->"`

`r if (!opts$cvperf) "<!--"`

```{r plotic50, eval = ("ic50" %in% opts$outcomes) & (opts$cvperf), fig.cap = paste0("Cross-validated $R^2$ for ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{50}$ (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50), " observations)")}
plot(fit_list_out$out$ic50, main_title = expression(IC[50]), xlim1 = -0.05, xlim2 = 0.8,
     text_size = 9, method = "method.CC_LS", opts = opts)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
 ggsave(filename = paste0("/home/output/ic50_slplot_", postfix, ".png"), plot = plot(fit_list_out$out$ic50, main_title = expression(IC[50]), xlim1 = -0.05, xlim2 = 0.8,
      text_size = 9, method = "method.CC_LS", opts = opts), width = 20, height = 20, units = "cm")
}
```

`r if(!opts$cvperf) "-->"`

`r if (!opts$cvperf | !("ic50" %in% opts$outcomes)) "<!--"`
Figure \@ref(fig:plotic50predversusoutcomes) shows cross-validated predictions of IC$_{50}$ plotted against observed values of `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{50}$, colored by cross-validation fold.

```{r plotic50predversusoutcomes, eval = ("ic50" %in% opts$outcomes) & (opts$cvperf), fig.cap = paste0("Cross-validated super learner predicted ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{50}$ plotted against actual IC$_{50}$ values (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50), " observations) . Colors correspond to cross-validation folds.")}
plot_cv_predictions(cv_fit = fit_list_out$out$ic50, outcome_name = expression(IC[50]), log_axis = FALSE)
# if save figs, save
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic50_cvpred_vs_outcomes_", postfix, ".png"), plot = plot_cv_predictions(cv_fit = fit_list_out$out$ic50, outcome_name = expression(IC[50]), log_axis = FALSE), width = 20, height = 20, units = "cm")
}
```
`r if (!opts$cvperf | !("ic50" %in% opts$outcomes)) "-->"`

`r if (!("ic50" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == ""))) "<!--"`

## Variable importance

`r if (!("ic50" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == ""))) "-->"`

`r if (!("ic50" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)))) "<!--"`

### Biological importance

`r if (!("ic50" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)))) "-->"`

`r if (!("ic50" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp))) "<!--"`

The biological variable importance of groups of features (defined in Table \@ref(tab:vimpGroupTab)) for predicting `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{50}$ is shown in Figure \@ref(fig:ic50groupvimp). Importance is defined using the difference in $R^2$ values.
`r get_biological_importance_plot_description(opts, grp = TRUE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.

```{r ic50groupvimp, eval = ("ic50" %in% opts$outcomes) & (("marg" %in% opts$importance_grp) | ("cond" %in% opts$importance_grp)), fig.cap = biological_importance_figure_caption(ncomplete_ic50, num_obs_fulls, num_obs_reds, outcome = "ic50", grp = TRUE, marg = "marg" %in% opts$importance_grp, cond = "cond" %in% opts$importance_grp, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_grp) & ("cond" %in% opts$importance_grp)) {
    ic50_grp_vimp_grob_lst <- list(switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$grp_marginal, log10.pc.ic50_cv_vimp_plots$grp_marginal), switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$grp_conditional, log10.pc.ic50_cv_vimp_plots$grp_conditional))
} else if ("marg" %in% opts$importance_grp) {
  ic50_grp_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$grp_marginal, log10.pc.ic50_cv_vimp_plots$grp_marginal)
} else {
  ic50_grp_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$grp_conditional, log10.pc.ic50_cv_vimp_plots$grp_conditional)
}
grid.arrange(grobs = list(ic50_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic50_biol_import_grp_", postfix, ".png"), plot = grid.arrange(grobs = list(ic50_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic50" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp))) "-->"`


`r if (!("ic50" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind))) "<!--"`

We show the biological variable importance of individual features in predicting `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{50}$ in Figure \@ref(fig:ic50indivimp). Importance is defined using the difference in $R^2$ values.
`r get_biological_importance_plot_description(opts, grp = FALSE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.

```{r ic50indivimp, eval = ("ic50" %in% opts$outcomes) & (("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)), fig.cap = biological_importance_figure_caption(ncomplete_ic50, num_obs_fulls, num_obs_reds, "ic50", grp = FALSE, marg = "marg" %in% opts$importance_ind, cond = "cond" %in% opts$importance_ind, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_ind) & ("cond" %in% opts$importance_ind)) {
    ic50_ind_vimp_grob_lst <- list(switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$ind_marginal, log10.pc.ic50_cv_vimp_plots$ind_marginal), switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$ind_conditional, log10.pc.ic50_cv_vimp_plots$ind_conditional))
} else if ("marg" %in% opts$importance_ind) {
  ic50_ind_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$ind_marginal, log10.pc.ic50_cv_vimp_plots$ind_marginal)
} else {
  ic50_ind_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic50_vimp_plots$ind_conditional, log10.pc.ic50_cv_vimp_plots$ind_conditional)
}
grid.arrange(grobs = list(ic50_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic50_biol_import_ind_", postfix, ".png"), plot = grid.arrange(grobs = list(ic50_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic50" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind))) "-->"`

`r if (!("ic50" %in% opts$outcomes) | !("pred" %in% opts$importance_ind)) "<!--"`

### Predictive importance

```{r get-pred-imp-ic50, eval = ("ic50" %in% opts$outcomes) & ("pred" %in% opts$importance_ind)}
fit_ic50 <- readRDS(paste0(slfits_dir, "fit_log10.pc.ic50.rds"))
imp_ic50 <- extract_importance(fit_ic50, opts)
```

Table \@ref(tab:ic50-imp-table) shows the top `r n_imp_ft` features. `r ifelse("ic50" %in% opts$outcomes & ("pred" %in% opts$importance_ind), get_importance_text(opts = opts, imp_df = imp_ic50), "")`

```{r ic50-imp-table, eval = "ic50" %in% opts$outcomes & ("pred" %in% opts$importance_ind)}
kable(imp_ic50[seq_len(n_imp_ft), c("Feature", "Importance")], row.names = FALSE,
      caption = paste0("The top ", n_imp_ft, " important features for predicting ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{50}$ as measured by their algorithm-specific importance."))
```

`r if (!("ic50" %in% opts$outcomes) | !("pred" %in% opts$importance_ind)) "-->"`

`r if(!("ic80" %in% opts$outcomes)) "<!--"`

# Results for IC$_{80}$

## Descriptive statistics

`r if(!("ic80" %in% opts$outcomes)) "-->"`

`r if ((length(opts$nab) == 1) | !("ic80" %in% opts$outcomes)) "<!--"`

Histograms of IC$_{80}$ for each individual bNAb are shown in Figure \@ref(fig:histic80). Related summary measures are shown in \@ref(tab:tableic80)

```{r, histic80, eval = ("ic80" %in% opts$outcomes) & (!one_nab), fig.cap = paste0("Distribution of IC$_{80}$ values (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic80), ") for each bNAb."), fig.height=5}
ic80_descr <- get_individual_nab_summaries("ic80", opts, dat_ic80)
do.call(grid.arrange, ic80_descr$hist)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic80_hist_", postfix, ".png"), plot = do.call(grid.arrange, ic80_descr$hist), width = 20, height = 20, units = "cm")
}
```

```{r, tableic80, eval = ("ic80" %in% opts$outcomes) & (!one_nab)}
ic80_table <- Reduce(rbind, ic80_descr$summary)
row.names(ic80_table) <- c(paste0("IC$_{80}$ ", opts$nab))
kable(ic80_table, row.names = TRUE, digits = 3,
      caption = paste0("Summary statistics of IC$_{80}$ values for individual bNAbs (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic80), " observations)."))
```

`r if ((length(opts$nab) == 1) | !("ic80" %in% opts$outcomes)) "-->"`

`r if (!("ic80" %in% opts$outcomes)) "<!--"`
A summary of the distribution of `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{80}$ for the `r ifelse(length(opts$nab) == 1, "", "combination of")` selected bNAb`r ifelse(length(opts$nab) == 1, "", "s")` is shown in Figure \@ref(fig:histcombnic80).

```{r makecapic80, eval = "ic80" %in% opts$outcomes}
ic80_figcap <- if(length(opts$nab) == 1){
  paste0("Histogram of IC$_{80}$ for the selected bNAb. Top row = original scale; bottom row = log$_{10}$ scale (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic80), " observations).")
}else{
  paste0("Histogram of estimated IC$_{80}$ for the combined bNAbs. Top row = original scale; bottom row = log$_{10}$ scale (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic80), " observations).")
}
```

```{r histcombnic80, eval = "ic80" %in% opts$outcomes, fig.cap = ic80_figcap}
combn_hist <- list()
combn_hist[[1]] <- make_hist_plot(dat_ic80, "pc.ic80", expression(IC[80]), "Density")
combn_hist[[2]] <- make_hist_plot(dat_ic80, "log10.pc.ic80", bquote(log[10]~"(IC"[80]~")"), "")
do.call(grid.arrange, combn_hist)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic80_combn_hist_", postfix, ".png"), plot = do.call(grid.arrange, combn_hist), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic80" %in% opts$outcomes)) "-->"`

`r if ((length(opts$learners) == 1) | !("ic80" %in% opts$outcomes)) "<!--"`

## Super learner results

The weights assigned to each algorithm for Super Learner predicting `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{80}$ are shown in Table \@ref(tab:ic80superlearnerweighttable).

```{r ic80superlearnerweighttable, eval = ("ic80" %in% opts$outcomes) & (length(opts$learners) > 1)}
weights_ic80 <- readRDS(paste0(slfits_dir, "slweights_fit_log10.pc.ic80.rds"))
weight_table <- data.frame(Learner = relabel_library(this_library), Weight = weights_ic80)
row.names(weight_table) <- NULL
# row.names(weight_table) <- this_library # will be defined in executive summary chunk
kable(as.data.frame(weight_table), digits = 2,
             caption = paste0("Table of super learner weights for ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{80}$ (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic80), " observations)."))
```

`r if ((length(opts$learners) == 1) | !("ic80" %in% opts$outcomes)) "-->"`

`r if (!opts$cvperf | !("ic80" %in% opts$outcomes)) "<!--"`

## Predictive performance

`r if (!opts$cvperf | !("ic80" %in% opts$outcomes)) "-->"`

`r if ((length(opts$learners) == 1 & !opts$cvtune) | !("ic80" %in% opts$outcomes) | !opts$cvperf) "<!--"`

The cross-validated $R^2$ of the super learner and constituent algorithms (descriptions of algorithms shown in Table \@ref(tab:sllibtab) in predicting `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{80}$ are shown in Figure \@ref(fig:plotic80).

`r if ((length(opts$learners) == 1 & !opts$cvtune) | !("ic80" %in% opts$outcomes) | !opts$cvperf) "-->"`

`r if ((length(opts$learners) > 1) | !("ic80" %in% opts$outcomes) | !opts$cvperf) "<!--"`

The cross-validated $R^2$ of the learner (with tuning parameters selected via cross-validation) and of the learner with each individual value of tuning parameters are shown in Figure \@ref(fig:plotic80).

`r if ((length(opts$learners) > 1) | !("ic80" %in% opts$outcomes) | !opts$cvperf) "-->"`

`r if (!("ic80" %in% opts$outcomes) | !opts$cvperf) "<!--"`
```{r plotic80, eval = ("ic80" %in% opts$outcomes) & (opts$cvperf), fig.cap = paste0("Cross-validated $R^2$ for ", ifelse(length(opts$nab) == 1, "", "estimated "), "IC$_{80}$ (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic80), " observations)")}
plot(fit_list_out$out$ic80, main_title = expression(IC[80]), xlim1 = -0.05, xlim2 = 0.8,
     text_size = 9, method = "method.CC_LS", opts = opts)
if ("figures" %in% opts$return) {
ggsave(filename = paste0("/home/output/ic80_slplot_", postfix, ".png"), plot = plot(fit_list_out$out$ic80, main_title = expression(IC[80]), xlim1 = -0.05, xlim2 = 0.8,
     text_size = 9, method = "method.CC_LS", opts = opts), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic80" %in% opts$outcomes) | !opts$cvperf) "-->"`

`r if (!("ic80" %in% opts$outcomes) | !opts$cvperf) "<!--"`
Figure \@ref(fig:plotic80predversusoutcomes) shows cross-validated predictions of `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{80}$ plotted against observed values of IC$_{80}$, colored by cross-validation fold.

```{r plotic80predversusoutcomes, eval = ("ic80" %in% opts$outcomes) & (opts$cvperf), fig.cap = paste0("Cross-validated super learner predicted ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{80}$ plotted against actual ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{80}$ values (n = ", ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic80), " observations) . Colors correspond to cross-validation folds.")}
plot_cv_predictions(cv_fit = fit_list_out$out$ic80, outcome_name = expression(IC[80]), log_axis = FALSE)
# if save figs, save
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic80_cvpred_vs_outcomes_", postfix, ".png"), plot = plot_cv_predictions(cv_fit = fit_list_out$out$ic80, outcome_name = expression(IC[80]), log_axis = FALSE), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic80" %in% opts$outcomes) | !opts$cvperf) "-->"`

`r if (!("ic80" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == ""))) "<!--"`

## Variable importance

`r if (!("ic80" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == ""))) "-->"`

<!-- If we did any population vimp, print it -->

`r if (!("ic80" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)))) "<!--"`

### Biological importance

`r if (!("ic80" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)))) "-->"`

<!-- If we did group vimp, print it -->

`r if (!("ic80" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp))) "<!--"`

We show the biological variable importance of groups of features (defined in Table \@ref(tab:vimpGroupTab)) in predicting `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{80}$ in Figure \@ref(fig:ic80groupvimp). Importance is defined using the difference in $R^2$ values.
`r get_biological_importance_plot_description(opts, grp = TRUE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r ic80groupvimp, eval = ("ic80" %in% opts$outcomes) & (("marg" %in% opts$importance_grp) | ("cond" %in% opts$importance_grp)), fig.cap = biological_importance_figure_caption(ncomplete_ic80, num_obs_fulls, num_obs_reds, "ic80", grp = TRUE, marg = "marg" %in% opts$importance_grp, cond = "cond" %in% opts$importance_grp, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_grp) & ("cond" %in% opts$importance_grp)) {
    ic80_grp_vimp_grob_lst <- list(switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$grp_marginal, log10.pc.ic80_cv_vimp_plots$grp_marginal), switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$grp_conditional, log10.pc.ic80_cv_vimp_plots$grp_conditional))
} else if ("marg" %in% opts$importance_grp) {
  ic80_grp_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$grp_marginal, log10.pc.ic80_cv_vimp_plots$grp_marginal)
} else {
  ic80_grp_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$grp_conditional, log10.pc.ic80_cv_vimp_plots$grp_conditional)
}
grid.arrange(grobs = list(ic80_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic80_biol_import_grp_", postfix, ".png"), plot = grid.arrange(grobs = list(ic80_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic80" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp))) "-->"`

<!-- If we did individual vimp, print it -->

`r if (!("ic80" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind))) "<!--"`

We show the biological variable importance of individual features in predicting `r ifelse(length(opts$nab) == 1, "", "estimated")` IC$_{80}$ in Figure \@ref(fig:ic80indivimp). Importance is defined using the difference in $R^2$ values.
`r get_biological_importance_plot_description(opts, grp = FALSE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r ic80indivimp, eval = ("ic80" %in% opts$outcomes) & (("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)), fig.cap = biological_importance_figure_caption(ncomplete_ic80, num_obs_fulls, num_obs_reds, "ic80", grp = FALSE, marg = "marg" %in% opts$importance_ind, cond = "cond" %in% opts$importance_ind, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_ind) & ("cond" %in% opts$importance_ind)) {
    ic80_ind_vimp_grob_lst <- list(switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$ind_marginal, log10.pc.ic80_cv_vimp_plots$ind_marginal), switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$ind_conditional, log10.pc.ic80_cv_vimp_plots$ind_conditional))
} else if ("marg" %in% opts$importance_ind) {
  ic80_ind_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$ind_marginal, log10.pc.ic80_cv_vimp_plots$ind_marginal)
} else {
  ic80_ind_vimp_grob_lst <- switch(opts$cvperf + 1,log10.pc.ic80_vimp_plots$ind_conditional, log10.pc.ic80_cv_vimp_plots$ind_conditional)
}
grid.arrange(grobs = list(ic80_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/ic80_biol_import_ind_", postfix, ".png"), plot = grid.arrange(grobs = list(ic80_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("ic80" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind))) "-->"`

`r if (!("ic80" %in% opts$outcomes) | !("pred" %in% opts$importance_ind)) "<!--"`
### Predictive importance

```{r get-pred-imp-ic80, eval = "ic80" %in% opts$outcomes & ("pred" %in% opts$importance_ind)}
fit_ic80 <- readRDS(paste0(slfits_dir, "fit_log10.pc.ic80.rds"))
imp_ic80 <- extract_importance(fit_ic80, opts)
```

Table \@ref(tab:ic80-imp-table) shows the top `r n_imp_ft` features. `r ifelse("ic80" %in% opts$outcomes & ("pred" %in% opts$importance_ind), get_importance_text(opts = opts, imp_df = imp_ic80), "")`

```{r ic80-imp-table, eval = "ic80" %in% opts$outcomes & ("pred" %in% opts$importance_ind)}
kable(imp_ic80[seq_len(n_imp_ft), c("Feature", "Importance")], row.names = FALSE,
      caption = paste0("The top ", n_imp_ft, " important features for predicting ", ifelse(length(opts$nab) == 1, "", "estimated"), " IC$_{80}$ as measured by their algorithm-specific importance."))
```

`r if (!("ic80" %in% opts$outcomes) | !("pred" %in% opts$importance_ind)) "-->"`

<!-- IIP section -->

`r if(!("iip" %in% opts$outcomes)) "<!--"`

# Results for IIP

## Descriptive statistics

A summary of the distribution of IIP for the `r ifelse(length(opts$nab) == 1, "", "combination of")`selected bNAb`r ifelse(length(opts$nab) == 1, "", "s")` is shown in Figure \@ref(fig:histcombniip).

```{r makecapiip, eval = "iip" %in% opts$outcomes}
iip_figcap <- if(length(opts$nab) == 1){
  paste0("Histogram of IIP for the selected bNAb (n = ", ncomplete_ic5080, " observations).")
}else{
  paste0("Histogram of estimated IIP for the combined bNAbs (n = ", ncomplete_ic5080, " observations).")
}
```

```{r histcombniip, eval = "iip" %in% opts$outcomes, fig.cap = iip_figcap}
combn_hist <- list()
combn_hist[[1]] <- make_hist_plot(dat_ic5080, "iip", "IIP", "Density")
do.call(grid.arrange, combn_hist)
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/iip_combn_hist_", postfix, ".png"), plot = do.call(grid.arrange, combn_hist), width = 20, height = 20, units = "cm")
}
```

`r if (!("iip" %in% opts$outcomes)) "-->"`

`r if (!("iip" %in% opts$outcomes) | (length(opts$learners) == 1)) "<!--"`

## Super learner results

The weights assigned to each algorithm for Super Learner predicting IIP are shown in Table \@ref(tab:iipsuperlearnerweighttable).

```{r iipsuperlearnerweighttable, eval = ("iip" %in% opts$outcomes) & (length(opts$learners) > 1)}
weights_iip <- readRDS(paste0(slfits_dir, "slweights_fit_iip.rds"))
weight_table <- data.frame(Learner = relabel_library(this_library), Weight = weights_iip)
row.names(weight_table) <- NULL
# row.names(weight_table) <- this_library # will be defined in executive summary chunk
kable(as.data.frame(weight_table), digits = 2,
             caption = paste0("Table of super learner weights for IIP (n = ", ncomplete_ic5080, " observations)."))
```

`r if (!("iip" %in% opts$outcomes) | (length(opts$learners) == 1)) "-->"`

`r if (!("iip" %in% opts$outcomes) | (!opts$cvperf)) "<!--"`

## Predictive performance

`r if (!("iip" %in% opts$outcomes) | (!opts$cvperf)) "-->"`

`r if (!("iip" %in% opts$outcomes) | (!opts$cvperf) | (length(opts$learners) == 1 & !opts$cvtune)) "<!--"`

The cross-validated $R^2$ of the super learner and constituent algorithms (descriptions of algorithms shown in Table \@ref(tab:sllibtab) in predicting IIP are shown in Figure \@ref(fig:plotiip).

`r if (!("iip" %in% opts$outcomes) | (!opts$cvperf) | (length(opts$learners) == 1 & !opts$cvtune)) "-->"`

`r if (!("iip" %in% opts$outcomes) | (!opts$cvperf) |(length(opts$learners) > 1)) "<!--"`

The cross-validated $R^2$ of the learner (with tuning parameters selected via cross-validation) and of the learner with each individual value of tuning parameters are shown in Figure \@ref(fig:plotiip).

`r if (!("iip" %in% opts$outcomes) | (!opts$cvperf) |(length(opts$learners) > 1)) "-->"`

`r if (!("iip" %in% opts$outcomes) | !opts$cvperf) "<!--"`
```{r plotiip, eval = ("iip" %in% opts$outcomes) & (opts$cvperf), fig.cap = paste0("Cross-validated $R^2$ for ", ifelse(length(opts$nab) == 1, "","estimated "), "IIP (", ncomplete_ic5080, " observations)")}
plot(fit_list_out$out$iip, main_title = "IIP", xlim1 = -0.05, xlim2 = 0.8,
     text_size = 9, method = "method.CC_LS", opts = opts)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
ggsave(filename = paste0("/home/output/ic50_slplot_", postfix, ".png"), plot = plot(fit_list_out$out$iip, main_title = "IIP", xlim1 = -0.05, xlim2 = 0.8,
     text_size = 9, method = "method.CC_LS", opts = opts), width = 20, height = 20, units = "cm")
}
```

Figure \@ref(fig:plotiippredversusoutcomes) shows cross-validated predictions of IIP plotted against observed values of IIP, colored by cross-validation fold.

```{r plotiippredversusoutcomes, eval = ("iip" %in% opts$outcomes) & (opts$cvperf), fig.cap = paste0("Cross-validated super learner predicted IIP plotted against actual IIP values (", ncomplete_ic5080, " observations) . Colors correspond to cross-validation folds.")}
plot_cv_predictions(cv_fit = fit_list_out$out$iip, outcome_name = "IIP", log_axis = FALSE)
# if save figs, save
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/iip_cvpred_vs_outcomes_", postfix, ".png"), plot = plot_cv_predictions(cv_fit = fit_list_out$out$iip, outcome_name = "IIP", log_axis = FALSE), width = 20, height = 20, units = "cm")
}
```
`r if (!("iip" %in% opts$outcomes) | !opts$cvperf) "-->"`

`r if (!("iip" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == ""))) "<!--"`
## Variable importance

`r if (!("iip" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == ""))) "-->"`

<!-- If we did any population vimp, print it -->

`r if (!("iip" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)))) "<!--"`

### Biological importance

`r if (!("iip" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)))) "-->"`

<!-- If we did group vimp, print it -->

`r if (!("iip" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp))) "<!--"`

We show the biological variable importance of groups of features (defined in Table \@ref(tab:vimpGroupTab)) in predicting IIP in Figure \@ref(fig:iipgroupvimp). Importance is defined using the difference in $R^2$ values.
`r get_biological_importance_plot_description(opts, grp = TRUE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r iipgroupvimp, eval = ("iip" %in% opts$outcomes) & (("marg" %in% opts$importance_grp) | ("cond" %in% opts$importance_grp)), fig.cap = biological_importance_figure_caption(ncomplete_ic5080, num_obs_fulls, num_obs_reds, "iip", grp = TRUE, marg = "marg" %in% opts$importance_grp, cond = "cond" %in% opts$importance_grp, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_grp) & ("cond" %in% opts$importance_grp)) {
    iip_grp_vimp_grob_lst <- list(switch(opts$cvperf + 1,iip_vimp_plots$grp_marginal, iip_cv_vimp_plots$grp_marginal), switch(opts$cvperf + 1,iip_vimp_plots$grp_conditional, iip_cv_vimp_plots$grp_conditional))
} else if ("marg" %in% opts$importance_grp) {
  iip_grp_vimp_grob_lst <- switch(opts$cvperf + 1,iip_vimp_plots$grp_marginal, iip_cv_vimp_plots$grp_marginal)
} else {
  iip_grp_vimp_grob_lst <- switch(opts$cvperf + 1,iip_vimp_plots$grp_conditional, iip_cv_vimp_plots$grp_conditional)
}
grid.arrange(grobs = list(iip_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/iip_biol_import_grp_", postfix, ".png"), plot = grid.arrange(grobs = list(iip_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("iip" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp))) "-->"`

<!-- If we did individual vimp, print it -->

`r if (!("iip" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind))) "<!--"`

We show the biological variable importance of individual features in predicting IIP in Figure \@ref(fig:iipindivimp). Importance is defined using the difference in $R^2$ values.
`r get_biological_importance_plot_description(opts, grp = FALSE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r iipindivimp, eval = ("iip" %in% opts$outcomes) & (("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)), fig.cap = biological_importance_figure_caption(ncomplete_ic5080, num_obs_fulls, num_obs_reds, "iip", grp = FALSE, marg = "marg" %in% opts$importance_ind, cond = "cond" %in% opts$importance_ind, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_ind) & ("cond" %in% opts$importance_ind)) {
    iip_ind_vimp_grob_lst <- list(switch(opts$cvperf + 1,iip_vimp_plots$ind_marginal, iip_cv_vimp_plots$ind_marginal), switch(opts$cvperf + 1,iip_vimp_plots$ind_conditional, iip_cv_vimp_plots$ind_conditional))
} else if ("marg" %in% opts$importance_ind) {
  iip_ind_vimp_grob_lst <- switch(opts$cvperf + 1,iip_vimp_plots$ind_marginal, iip_cv_vimp_plots$ind_marginal)
} else {
  iip_ind_vimp_grob_lst <- switch(opts$cvperf + 1,iip_vimp_plots$ind_conditional, iip_cv_vimp_plots$ind_conditional)
}
grid.arrange(grobs = list(iip_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/iip_biol_import_ind_", postfix, ".png"), plot = grid.arrange(grobs = list(iip_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("iip" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind))) "-->"`

`r if (!("iip" %in% opts$outcomes) | !("pred" %in% opts$importance_ind)) "<!--"`

### Predictive importance

```{r get-pred-imp-iip, eval = "iip" %in% opts$outcomes & ("pred" %in% opts$importance_ind)}
fit_iip <- readRDS(paste0(slfits_dir, "fit_iip.rds"))
imp_iip <- extract_importance(fit_iip, opts)
```

Table \@ref(tab:iip-imp-table) shows the top `r n_imp_ft` features. `r ifelse("iip" %in% opts$outcomes & ("pred" %in% opts$importance_ind), get_importance_text(opts = opts, imp_df = imp_iip), "")`

```{r iip-imp-table, eval = "iip" %in% opts$outcomes & ("pred" %in% opts$importance_ind)}
kable(imp_iip[seq_len(n_imp_ft), c("Feature", "Importance")], row.names = FALSE,
      caption = paste0("The top ", n_imp_ft, " important features for predicting IIP as measured by their algorithm-specific importance."))
```

`r if (!("iip" %in% opts$outcomes) | !("pred" %in% opts$importance_ind)) "-->"`

<!-- estimated sensitivity -->

`r if (!("sens1" %in% opts$outcomes)) "<!--"`

# Results for `r est_fillin` sensitivity

## Descriptive statistics
Out of the sequences with complete data, `r sum(dat_ic50$dichotomous.1)` were `r ifelse(one_nab, "estimated to be", "")` sensitive to the `r ifelse(!one_nab, "combination of antibodies", "antibody")`, while `r ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50) - sum(dat_ic50$dichotomous.1)` were `r ifelse(one_nab, "estimated to be", "")` resistant, where `r est_fillin` sensitivity was defined as the indicator that `r est_fillin` IC${_50}$ was less than `r opts$sens_thresh`. `r ifelse(!run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]], paste0("There were too few observations in at least one class for results to be reliable, and thus ", est_fillin, " sensitivity is not included in any learning or population variable importance analyses. "), ifelse(!run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]], paste0("There were too few observations in at least one class for variable importance results to be reliable, and thus ", est_fillin, "sensitivity is not included in any population variable importance analyses. "), ""))`

`r if (!("sens1" %in% opts$outcomes)) "-->"`

`r if (!("sens1" %in% opts$outcomes) | (length(opts$learners) == 1) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

## Super learner results

The weights assigned to each algorithm for Super Learner predicting `r est_fillin` sensitivity are shown in Table \@ref(tab:sens1superlearnerweighttable).

```{r sens1superlearnerweighttable, eval = ("sens1" %in% opts$outcomes) & (length(opts$learners) > 1) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]}
weights_sens1 <- readRDS(paste0(slfits_dir, "slweights_fit_dichotomous.1.rds"))
weight_table <- data.frame(Learner = relabel_library(this_library), Weight = weights_sens1)
row.names(weight_table) <- NULL
# row.names(weight_table) <- this_library # will be defined in executive summary chunk
kable(as.data.frame(weight_table), digits = 2,
             caption = paste0("Table of super learner weights for ", est_fillin, "sensitivity (n = ", ncomplete_ic50, " observations)."))
```

`r if (!("sens1" %in% opts$outcomes) | (length(opts$learners) == 1) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens1" %in% opts$outcomes) | (!opts$cvperf) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

## Predictive performance

`r if (!("sens1" %in% opts$outcomes) | (!opts$cvperf) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens1" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & "sens1" %in% opts$outcomes) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

The cross-validated area under the ROC curve of super learner predictions of `r est_fillin` sensitivity relative to candidate algorithms is shown in Figure \@ref(fig:plotdichot1). Figure \@ref(fig:rocdichot1) shows cross-validated ROC curves for this endpoint.

`r if (!("sens1" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & "sens1" %in% opts$outcomes) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens1" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & "sens1" %in% opts$outcomes) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

The cross-validated area under the ROC curve of the learner with tuning parameters selected via cross-validation and learners with each individual value of tuning parameters are shown in Figure \@ref(fig:rocdichot1).

```{r plotdichot1, eval = ("sens1" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]], fig.cap = paste0("Cross-validated AUC for predicting ", est_fillin, "sensitivity (n = ", ncomplete_ic50, " observations).")}
plot(fit_list_out$out$sens1, main_title = ifelse(length(opts$nab) == 1, "Estimated sensitivity", "Sensitivity"), xlim1 = 0.4, xlim2 = 1, text_size = 9,
     Rsquared = FALSE, method = "method.AUC", opts = opts)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
ggsave(filename = paste0("/home/output/ic50_slplot_", postfix, ".png"), plot = plot(fit_list_out$out$sens1, main_title = ifelse(length(opts$nab) == 1, "Estimated sensitivity", "Sensitivity"), xlim1 = 0.4, xlim2 = 1, text_size = 9,
     Rsquared = FALSE, method = "method.AUC", opts = opts), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens1" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & "sens1" %in% opts$outcomes) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens1" %in% opts$outcomes) | !opts$cvperf | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

Figure \@ref(fig:rocdichot1) shows the cross-validated ROC curve for predicting `r est_fillin` sensitivity.

```{r roccap1, eval = ("sens1" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]}
roc_cap <- if(length(opts$learners) > 1){
  paste0("Cross-validated ROC curve for the super learner, discrete super learner, and single best performing algorithm for predicting ", est_fillin, "sensitivity (n = ", ncomplete_ic50, " observations).")
}else if(!opts$cvtune){
  paste0("Cross-validated ROC curve for the specified learner for predicting ", est_fillin, "sensitivity (n = ", ncomplete_ic50, " observations).")
}else{
  paste0("Cross-validated ROC curve for the learner (with tuning parameters selected via cross-validation) for predicting ", est_fillin, "sensitivity (n = ", ncomplete_ic50, " observations).")
}

predprob_cap <- if(length(opts$learners) > 1){
  paste0("Cross-validated predicted probabilities of ", est_fillin, "resistance made by super learner, discrete super learner, and single best performing algorithm colored by cross-validation fold (n = ", ncomplete_ic50, " observations).")
}else if(!opts$cvtune){
  paste0("Cross-validated predicted probabilities of ", est_fillin, "resistance made by the specified learner colored by cross-validation fold (n = ", ncomplete_ic50, " observations).")
}else{
  paste0("Cross-validated predicted probabilities of ", est_fillin, "resistance made by the cross-validation-tuned learner colored by cross-validation fold (n = ", ncomplete_ic50, " observations).")
}
```

```{r rocdichot1, fig.cap = roc_cap, eval = ("sens1" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]}
plot_roc_curves(fit_list_out$out$sens1, opts = opts)
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens1_roc_", postfix, ".png"), plot = plot_roc_curves(fit_list_out$out$sens1, opts = opts), width = 20, height = 20, units = "cm")
}
```

```{r predprob1, fig.cap = predprob_cap, eval = ("sens1" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]}
plot_predicted_prob_boxplots(fit_list_out$out$sens1, opts = opts)
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens1_predprob_", postfix, ".png"), plot = plot_predicted_prob_boxplots(fit_list_out$out$sens1, opts = opts), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens1" %in% opts$outcomes) | !opts$cvperf | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens1" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == "")) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

## Variable importance

`r if (!("sens1" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == "")) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- If we did any population vimp, print it -->

`r if (!("sens1" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind))) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

### Biological importance

`r if (!("sens1" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind))) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- If we did group vimp, print it -->

`r if (!("sens1" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

We show the biological variable importance of groups of features (defined in Table \@ref(tab:vimpGroupTab)) in predicting `r est_fillin` sensitivity in Figure \@ref(fig:sens1groupvimp). Importance is defined using the difference in AUCs.
`r get_biological_importance_plot_description(opts, grp = TRUE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r sens1groupvimp, eval = ("sens1" %in% opts$outcomes) & (("marg" %in% opts$importance_grp) | ("cond" %in% opts$importance_grp)) & run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]], fig.cap = biological_importance_figure_caption(ncomplete_ic50, num_obs_fulls, num_obs_reds, "sens1", grp = TRUE, marg = "marg" %in% opts$importance_grp, cond = "cond" %in% opts$importance_grp, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_grp) & ("cond" %in% opts$importance_grp)) {
    sens1_grp_vimp_grob_lst <- list(switch(opts$cvperf + 1,dichotomous.1_vimp_plots$grp_marginal, dichotomous.1_cv_vimp_plots$grp_marginal), switch(opts$cvperf + 1,dichotomous.1_vimp_plots$grp_conditional, dichotomous.1_cv_vimp_plots$grp_conditional))
} else if ("marg" %in% opts$importance_grp) {
  sens1_grp_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.1_vimp_plots$grp_marginal, dichotomous.1_cv_vimp_plots$grp_marginal)
} else {
  sens1_grp_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.1_vimp_plots$grp_conditional, dichotomous.1_cv_vimp_plots$grp_conditional)
}
grid.arrange(grobs = list(sens1_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens1_biol_import_grp_", postfix, ".png"), plot = grid.arrange(grobs = list(sens1_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens1" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- If we did individual vimp, print it -->

`r if (!("sens1" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

We show the biological variable importance of individual features in predicting `r est_fillin` sensitivity in Figure \@ref(fig:sens1indivimp). Importance is defined using the difference in AUCs.
`r get_biological_importance_plot_description(opts, grp = FALSE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r sens1indivimp, eval = ("sens1" %in% opts$outcomes) & (("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)) & run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]], fig.cap = biological_importance_figure_caption(ncomplete_ic50, num_obs_fulls, num_obs_reds, "sens1", grp = FALSE, marg = "marg" %in% opts$importance_ind, cond = "cond" %in% opts$importance_ind, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_ind) & ("cond" %in% opts$importance_ind)) {
    sens1_ind_vimp_grob_lst <- list(switch(opts$cvperf + 1,dichotomous.1_vimp_plots$ind_marginal, dichotomous.1_cv_vimp_plots$ind_marginal), switch(opts$cvperf + 1,dichotomous.1_vimp_plots$ind_conditional, dichotomous.1_cv_vimp_plots$ind_conditional))
} else if ("marg" %in% opts$importance_ind) {
  sens1_ind_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.1_vimp_plots$ind_marginal, dichotomous.1_cv_vimp_plots$ind_marginal)
} else {
  sens1_ind_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.1_vimp_plots$ind_conditional, dichotomous.1_cv_vimp_plots$ind_conditional)
}
grid.arrange(grobs = list(sens1_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens1_biol_import_ind_", postfix, ".png"), plot = grid.arrange(grobs = list(sens1_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens1" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens1" %in% opts$outcomes) | !("pred" %in% opts$importance_ind) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

### Predictive importance

```{r get-pred-imp-sens1, eval = "sens1" %in% opts$outcomes & ("pred" %in% opts$importance_ind) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]}
fit_sens1 <- readRDS(paste0(slfits_dir, "fit_dichotomous.1.rds"))
imp_sens1 <- extract_importance(fit_sens1, opts)
```

Table \@ref(tab:sens1-imp-table) shows the top `r n_imp_ft` features. `r ifelse("sens1" %in% opts$outcomes & ("pred" %in% opts$importance_ind) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]], get_importance_text(opts = opts, imp_df = imp_sens1), "")`

```{r sens1-imp-table, eval = "sens1" %in% opts$outcomes & ("pred" %in% opts$importance_ind) & run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]}
kable(imp_sens1[seq_len(n_imp_ft), c("Feature", "Importance")], row.names = FALSE,
      caption = paste0("The top ", n_imp_ft, " important features for predicting ", est_fillin, "sensitivity as measured by their algorithm-specific importance."))
```


`r if (!("sens1" %in% opts$outcomes) | !("pred" %in% opts$importance_ind) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.1", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- multiple sensitivity section -->

`r if (!("sens2" %in% opts$outcomes)) "<!--"`

# Results for multiple sensitivity

## Descriptive statistics

Out of the `r ncomplete_ic50` sequences, `r sum(dat_ic50$dichotomous.2)` were estimated to be resistant to the `r ifelse(!one_nab, "combination of antibodies", "antibody")`, while `r ncomplete_ic50 - sum(dat_ic50$dichotomous.2)` were estimated to be sensitive.

`r if (!("sens2" %in% opts$outcomes)) "-->"`

<!-- if we used more than one learner, display SL results -->

`r if (!("sens2" %in% opts$outcomes) | (length(opts$learners) == 1) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`
## Super learner results

The weights assigned to each algorithm for Super Learner predicting multiple sensitivity are shown in Table \@ref(tab:sens2superlearnerweighttable)\.

```{r sens2superlearnerweighttable, eval = ("sens2" %in% opts$outcomes) & (length(opts$learners) > 1) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]}
weights_sens2 <- readRDS(paste0(slfits_dir, "slweights_fit_dichotomous.2.rds"))
weight_table <- data.frame(Learner = relabel_library(this_library), Weight = weights_sens2)
row.names(weight_table) <- NULL
# row.names(weight_table) <- this_library # will be defined in executive summary chunk
kable(as.data.frame(weight_table), digits = 2,
             caption = paste0("Table of super learner weights for multiple sensitivity (n = ", ncomplete_ic50, " observations)."))
```

`r if (!("sens2" %in% opts$outcomes) | (length(opts$learners) == 1) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- cv performance section -->

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

## Predictive performance

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & !opts$cvtune) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

The cross-validated area under the ROC curve for the super learner in predicting multiple sensitivity relative to other candidate algorithms is shown in Figure \@ref(fig:plotdichot2). Figure \@ref(fig:rocdichot2) shows cross-validated ROC curves for this endpoint.

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & !opts$cvtune) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & !opts$cvtune) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

The cross-validated area under the ROC curve for the learner with tuning parameters selected via cross-validation and for learners with each individual value of tuning parameters are shown in Figure \@ref(fig:rocdichot2).

```{r plotdichot2, eval = ("sens2" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]], fig.cap = paste0("Cross-validated AUC for multiple sensitivity (n = ", ncomplete_ic50, " observations).")}
plot(fit_list_out$out$sens2, main_title = "Multiple sensitivity", xlim1 = 0.4, xlim2 = 1, text_size = 9,
     Rsquared = FALSE, method = "method.AUC", opts = opts)
# if saving figures was requested, save
if ("figures" %in% opts$return) {
ggsave(filename = paste0("/home/output/ic50_slplot_", postfix, ".png"), plot = plot(fit_list_out$out$sens2, main_title = "Multiple sensitivity", xlim1 = 0.4, xlim2 = 1, text_size = 9,
     Rsquared = FALSE, method = "method.AUC", opts = opts), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | (length(opts$learners) == 1 & !opts$cvtune) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`
Figure \@ref(fig:rocdichot2) shows the cross-validated ROC curve for predicting multiple sensitivity.

```{r roccap2, eval = ("sens2" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]}
roc_cap <- if(length(opts$learners) > 1){
  paste0("Cross-validated ROC curve for the super learner, discrete super learner, and single best performing algorithm for predicting multiple sensitivity (n = ", ncomplete_ic50, " observations).")
}else if(!opts$cvtune){
  paste0("Cross-validated ROC curve for the specified learner for predicting multiple sensitivity (n = ", ncomplete_ic50, " observations).")
}else{
  paste0("Cross-validated ROC curve for the learner (with tuning parameters selected via cross-validation) for predicting multiple sensitivity (n = ", ncomplete_ic50, " observations).")
}

predprob_cap <- if(length(opts$learners) > 1){
  paste0("Cross-validated predicted probabilities of multiple resistance made by super learner, discrete super learner, and single best performing algorithm colored by cross-validation fold (n = ", ncomplete_ic50, " observations).")
}else if(!opts$cvtune){
  paste0("Cross-validated predicted probabilities of multiple resistance made by the specified learner colored by cross-validation fold (n = ", ncomplete_ic50, " observations).")
}else{
  paste0("Cross-validated predicted probabilities of multiple resistance made by the cross-validation-tuned learner colored by cross-validation fold (n = ", ncomplete_ic50, " observations).")
}
```

```{r rocdichot2, fig.cap = roc_cap, eval = ("sens2" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]}
plot_roc_curves(fit_list_out$out$sens2, opts = opts)
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens2_roc_", postfix, ".png"), plot = plot_roc_curves(fit_list_out$out$sens2, opts = opts), width = 20, height = 20, units = "cm")
}
```

```{r predprob2, fig.cap = predprob_cap, eval = ("sens2" %in% opts$outcomes) & (opts$cvperf) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]}
plot_predicted_prob_boxplots(fit_list_out$out$sens2, opts = opts)
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens2_predprob_", postfix, ".png"), plot = plot_predicted_prob_boxplots(fit_list_out$out$sens2, opts = opts), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens2" %in% opts$outcomes) | !opts$cvperf | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens2" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == "")) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`
## Variable importance

`r if (!("sens2" %in% opts$outcomes) | (all(opts$importance_grp == "") & all(opts$importance_ind == "")) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- If we did any population vimp, print it -->

`r if (!("sens2" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind))) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

### Biological importance

`r if (!("sens2" %in% opts$outcomes) | ((opts$importance_grp == "") & !(("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind))) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- If we did group vimp, print it -->

`r if (!("sens2" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

We show the biological variable importance of groups of features (defined in Table \@ref(tab:vimpGroupTab)) in predicting multiple sensitivity in Figure \@ref(fig:sens2groupvimp). Importance is defined using the difference in AUCs.
`r get_biological_importance_plot_description(opts, grp = TRUE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r sens2groupvimp, eval = ("sens2" %in% opts$outcomes) & (("marg" %in% opts$importance_grp) | ("cond" %in% opts$importance_grp)) & run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]], fig.cap = biological_importance_figure_caption(ncomplete_ic50, num_obs_fulls, num_obs_reds, "sens2", grp = TRUE, marg = "marg" %in% opts$importance_grp, cond = "cond" %in% opts$importance_grp, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_grp) & ("cond" %in% opts$importance_grp)) {
    sens2_grp_vimp_grob_lst <- list(switch(opts$cvperf + 1,dichotomous.2_vimp_plots$grp_marginal, dichotomous.2_cv_vimp_plots$grp_marginal), switch(opts$cvperf + 1,dichotomous.2_vimp_plots$grp_conditional, dichotomous.2_cv_vimp_plots$grp_conditional))
} else if ("marg" %in% opts$importance_grp) {
  sens2_grp_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.2_vimp_plots$grp_marginal, dichotomous.2_cv_vimp_plots$grp_marginal)
} else {
  sens2_grp_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.2_vimp_plots$grp_conditional, dichotomous.2_cv_vimp_plots$grp_conditional)
}
grid.arrange(grobs = list(sens2_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens2_biol_import_grp_", postfix, ".png"), plot = grid.arrange(grobs = list(sens2_grp_vimp_grob_lst), ncol = length(opts$importance_grp), top = "Group Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens2" %in% opts$outcomes) | (!("marg" %in% opts$importance_grp) & !("cond" %in% opts$importance_grp)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

<!-- If we did individual vimp, print it -->

`r if (!("sens2" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`

We show the biological variable importance of individual features in predicting multiple sensitivity in Figure \@ref(fig:sens2indivimp). Importance is defined using the difference in AUCs.
`r get_biological_importance_plot_description(opts, grp = FALSE)` `r (1-vimp_threshold)*100`\% confidence intervals and stars denoting p-values less than `r vimp_threshold` are displayed in blue.


```{r sens2indivimp, eval = ("sens2" %in% opts$outcomes) & (("marg" %in% opts$importance_ind) | ("cond" %in% opts$importance_ind)) & run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]], fig.cap = biological_importance_figure_caption(ncomplete_ic50, num_obs_fulls, num_obs_reds, "sens2", grp = FALSE, marg = "marg" %in% opts$importance_ind, cond = "cond" %in% opts$importance_ind, opts = opts), fig.subcap = c("Marginal importance", "Conditional importance")}
if (("marg" %in% opts$importance_ind) & ("cond" %in% opts$importance_ind)) {
    sens2_ind_vimp_grob_lst <- list(switch(opts$cvperf + 1,dichotomous.2_vimp_plots$ind_marginal, dichotomous.2_cv_vimp_plots$ind_marginal), switch(opts$cvperf + 1,dichotomous.2_vimp_plots$ind_conditional, dichotomous.2_cv_vimp_plots$ind_conditional))
} else if ("marg" %in% opts$importance_ind) {
  sens2_ind_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.2_vimp_plots$ind_marginal, dichotomous.2_cv_vimp_plots$ind_marginal)
} else {
  sens2_ind_vimp_grob_lst <- switch(opts$cvperf + 1,dichotomous.2_vimp_plots$ind_conditional, dichotomous.2_cv_vimp_plots$ind_conditional)
}
grid.arrange(grobs = list(sens2_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance")
if ("figures" %in% opts$return) {
    ggsave(filename = paste0("/home/output/sens2_biol_import_ind_", postfix, ".png"), plot = grid.arrange(grobs = list(sens2_ind_vimp_grob_lst), ncol = ifelse("pred" %in% opts$importance_ind, length(opts$importance_ind) - 1, length(opts$importance_ind)), top = "Individual Biological Variable Importance"), width = 20, height = 20, units = "cm")
}
```

`r if (!("sens2" %in% opts$outcomes) | (!("marg" %in% opts$importance_ind) & !("cond" %in% opts$importance_ind)) | !run_sl_vimp_bools$run_vimp[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (!("sens2" %in% opts$outcomes) | !("pred" %in% opts$importance_ind) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "<!--"`
### Predictive importance

```{r get-pred-imp-sens2, eval = "sens2" %in% opts$outcomes & ("pred" %in% opts$importance_ind) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]}
fit_sens2 <- readRDS(paste0(slfits_dir, "fit_dichotomous.2.rds"))
imp_sens2 <- extract_importance(fit_sens2, opts)
```

Table \@ref(tab:sens2-imp-table) shows the top `r n_imp_ft` features. `r ifelse("sens2" %in% opts$outcomes & ("pred" %in% opts$importance_ind) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]], get_importance_text(opts = opts, imp_df = imp_sens2), "")`

```{r sens2-imp-table, eval = "sens2" %in% opts$outcomes & ("pred" %in% opts$importance_ind) & run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]}
kable(imp_sens2[seq_len(n_imp_ft), c("Feature", "Importance")], row.names = FALSE,
      caption = paste0("The top ", n_imp_ft, " important features for predicting multiple sensitivity as measured by their algorithm-specific importance."))
```
`r if(!("sens2" %in% opts$outcomes) | !("pred" %in% opts$importance_ind) | !run_sl_vimp_bools$run_sl[grepl("dichotomous.2", names(run_sl_vimp_bools$run_vimp))][[1]]) "-->"`

`r if (opts$importance_grp == "") "<!--"`
# Variable group definitions

Table \@ref(tab:vimpGroupTab) provides the individual HXB2 coordinates and variable names of the variables that make up each of the variable groups considered for biological importance.

```{r vimpGroupTab, eval = !(opts$importance_grp == "")}
# all_var_groups is created in preamble
var_grps_chr_lst <- lapply(lapply(all_var_groups, function(x) strsplit(x, ".", fixed = TRUE)), function(x) do.call(c, lapply(x, function(y) paste0(y[!grepl("hxb2", y) & !grepl("mer", y)], collapse = "."))))
grptab <- do.call(rbind, lapply(var_grps_chr_lst, function(x) paste0(x, collapse = ", ")))
kable(grptab, col.names = "Variables",
      digits = 3, row.names = TRUE,
      caption = "Individual variables within each variable group.")
```

`r if (opts$importance_grp == "") "-->"`

# References
