---
title: "SLAPNAP Metadata: `r paste(format(strsplit(Sys.getenv('nab'), split = ';')[[1]], justify = 'none'), collapse = ', ')`"
author: "SLAPNAP Team"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: bookdown::html_document2
header-includes:
   - \usepackage{subfig}
bibliography: refs.bib
link-citations: true
---

```{r setup, include=FALSE}
code_dir <- "/home/lib/"
slfits_dir <- "/home/slfits/"
data_dir <- "/home/dat/"
output_dir <- "/home/output/"

## ----------------------------------------------------------------------------
## Knitr options, packages, files
## ----------------------------------------------------------------------------
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

options(stringsAsFactors = FALSE)

library(grid)
library(magrittr)
library(ggplot2)
library(cowplot)
theme_set(theme_cowplot())
library(dplyr)
library(tidyr)
library(ROCR)
library(knitr)
library(gridExtra)
library(xgboost); library(ranger); library(glmnet)
library(vimp)
library(tibble)
library(stringr)
source(paste0(code_dir, "variable_groups.R"))
source(paste0(code_dir, "super_learner_libraries.R"))
source(paste0(code_dir, "utils.R"))
source(paste0(code_dir, "plotting_functions.R"))
source(paste0(code_dir, "ml_var_importance_measures.R"))
source(paste0(code_dir, "var_import_plot.R"))
source(paste0(code_dir, "vimp_executive_summary_table.R"))
source(paste0(code_dir, "plot_one_vimp.R"))
source(paste0(code_dir, "variable_groups.R"))
```

```{r get-options-and-dataset}
opts <- get_global_options()
# boolean of single nab
one_nab <- length(opts$nab) == 1
est_fillin <- ifelse(one_nab, "", "estimated ")
any_cont <- any(c("ic50", "ic80") %in% opts$outcomes)
any_dich <- any(c("sens1", "sens2") %in% opts$outcomes)
# read in number of observations
nprevious <- readRDS(paste0(slfits_dir, "nprevious.rds"))
ncomplete_features <- readRDS(paste0(slfits_dir, "ncomplete_features.rds"))
ncomplete_ic50 <- readRDS(paste0(slfits_dir, "ncomplete_ic50.rds"))
ncomplete_ic80 <- readRDS(paste0(slfits_dir, "ncomplete_ic80.rds"))
ncomplete_ic5080 <- readRDS(paste0(slfits_dir, "ncomplete_ic5080.rds"))
analysis_data_names <- list.files("/home/dat/analysis")
analysis_data_name <- get_analysis_dataset_name(analysis_data_names, opts)
dat <- read.csv(paste0(data_dir, "analysis/", analysis_data_name), header = TRUE)
dat <- dat[complete.cases(dat),]
# make nice outcome names
all_outcomes <- c("ic50", "ic80", "iip", "sens1", "sens2")
all_labels <- c("IC-50", "IC-80", "IIP", ifelse(one_nab, "Sensitivity", "Estimated sensitivity"), "Multiple sensitivity")
nice_outcomes <- opts$outcomes
for(i in seq_along(all_outcomes)){
    nice_outcomes <- gsub(all_outcomes[i], all_labels[i], nice_outcomes)
}
outcome_names <- get_outcome_names(opts)
# set number of CV folds
V <- as.numeric(opts$nfolds)
# check the outcomes to see if we can run them or not
run_sl_vimp_bools <- check_outcomes(dat, outcome_names, V)
# now format continuous outcomes table
cont_idx <- which(opts$outcomes %in% c("ic50", "ic80", "iip"))
bin_idx <- which(opts$outcomes %in% c("sens1", "sens2"))
cont_nms <- nice_outcomes[cont_idx]
bin_nms <- nice_outcomes[bin_idx]
# postfix for naming plots
postfix <- paste0(paste(opts$nab, collapse = "_"), "_", format(Sys.time(), "%d%b%Y"))
# get clean analysis dataset
clean_data_names <- list.files(output_dir)
analysis_data_name <- get_analysis_dataset_name(clean_data_names, opts)
analysis_dataset <- read.csv(paste0(output_dir, analysis_data_name), stringsAsFactors = FALSE)
```

# Executive summary

This file describes the analysis dataset `r analysis_data_name`.

The broadly neutralizing antibod`r ifelse(!one_nab, "ies (bNAbs)", "y (bNAb)")` studied in this analysis `r ifelse(!one_nab, "are ", "is ")` `r paste0(paste0(antibodies[-length(antibodies)], collapse = ", "), ifelse(length(antibodies) > 1, paste0(" and ", antibodies[length(antibodies)]), antibodies))`. The analysis considered `r length(opts$outcomes)` `r ifelse(length(opts$outcomes) == 1, "measure", "measures")` of neutralization sensitivity: `r get_comma_sep_outcomes(opts)` `r get_outcome_descriptions(opts)` Based on this specification of `r ifelse(!one_nab, "bNAbs", "bNAb")` and `r ifelse(length(opts$outcomes) > 1, "outcomes", "outcome")`:

* `r nprevious` sequences were extracted from the CATNAP database [@yoon2015catnap];

* `r ncomplete_features` sequences had complete geographic and genetic sequence information;

* `r paste0(get_complete_data_text(opts, ncomplete_ic50, ncomplete_ic80, ncomplete_ic5080, iip_undef), ifelse(any_dich, ";", "."))`
`r if(!("iip" %in% opts$outcomes) | iip_undef == 0 | opts$same_subset) "<!--"`
* out of the sequences with both IC$_{50}$ and IC$_{80}$ measured, `r iip_undef` `r ifelse(iip_undef == 1, "has", "have")` the same measured value of IC$_{50}$ and IC$_{80}$, which led to an undefined value for IIP and `r ifelse(iip_undef == 1, "its", "their")` exclusion from IIP analyses.
`r if(!("iip" %in% opts$outcomes) | iip_undef == 0 | opts$same_subset) "-->"`
`r if(!("sens1" %in% opts$outcomes)) "<!--"`
* out of the sequences with complete data, `r sum(dat_ic50$dichotomous.1)` were `r ifelse(one_nab, "", "estimated to be")` sensitive to the `r ifelse(!one_nab, "combination of bNAbs", "bNAb")`, while `r ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50) - sum(dat_ic50$dichotomous.1)` were `r ifelse(one_nab, "", "estimated to be")` resistant, where `r est_fillin` sensitivity was defined as the indicator that `r est_fillin` IC$_{50}$ was less than `r opts$sens_thresh``r check_sl_vimp_bin(opts, run_sl_vimp_bools, "sens1")``r ifelse("sens2" %in% opts$outcomes, ";", ".")`
`r if(!("sens1" %in% opts$outcomes)) "-->"`
`r if(!("sens2" %in% opts$outcomes)) "<!--"`
* out of the sequences with complete data, `r sum(dat_ic50$dichotomous.2)` were estimated to be sensitive to `r ifelse(opts$multsens_nab == length(opts$nab), paste0(ifelse(length(opts$nab) == 2, "both", "all of the"), " bNAbs"), paste0("at least ", opts$multsens_nab, ifelse(opts$multsens_nab == 1, "bNAb", "bNAbs")))`, while `r ifelse(opts$same_subset, ncomplete_ic5080, ncomplete_ic50) - sum(dat_ic50$dichotomous.2)` were estimated to be resistant to `r ifelse(opts$multsens_nab == 1, paste0(ifelse(length(opts$nab) == 2, "both", "all of the"), " bNAbs"), ifelse(length(opts$nab) - as.numeric(opts$multsens_nab) == 1, "one of the bNAbs", paste0(length(opts$nab) - as.numeric(opts$multsens_nab) + 1, ifelse(length(opts$nab) - as.numeric(opts$multsens_nab) == 0, " ", " or more "), "of the bNAbs")))``r check_sl_vimp_bin(opts, run_sl_vimp_bools, "sens2")`
`r if(!("sens2" %in% opts$outcomes)) "-->"`

# Variables in the dataset

Table \@ref(tab:variables) provides the name and description of each variable in the returned dataset.

```{r variables}
metadata_tab <- create_metadata(analysis_dataset, opts)
kable(metadata_tab, caption = "Variables in the analysis dataset, with names and descriptions.")
```

# References
